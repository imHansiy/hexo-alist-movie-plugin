# Hexo Alist Movie Plugin 开发规则

## 1. 项目概述

本插件是一个为 [Hexo](https://hexo.io/) 设计的扩展，旨在集成 [Alist](https://alist.nn.ci/) 和 [TMDb](https://www.themoviedb.org/) 的数据源，自动生成一个电影信息展示页面和一个功能独立的在线播放页面。

## 2. 架构设计

项目采用了“后端生成数据，前端拉取渲染”的分离式架构。

*   **后端 (Hexo 生成阶段)**: 在 `hexo generate` 过程中，插件会调用 Alist 和 TMDb 的 API，获取并处理所有电影数据，最终生成一个静态的 `movies.json` 文件。
*   **前端 (页面渲染)**:
    *   电影列表页 (`movies.ejs`) 由 Hexo 直接渲染，展示所有电影的概览。
    *   播放页 (`player/`) 是一个独立的单页应用 (SPA)，它通过 `fetch` API 异步加载 `movies.json`，并根据 URL 参数动态渲染特定电影的详细信息。

**优点**:
*   **URL 简洁**: 播放页的 URL 结构清晰（例如 `/player/?movie_id=123`），不依赖 Hexo 的文章路径。
*   **可扩展性强**: 前后端逻辑分离，使得播放页可以独立于 Hexo 主题进行开发和功能迭代。

## 3. 数据流

1.  [`index.js`](./index.js) (插件主入口) 调用 Alist API，获取指定目录下的文件列表作为电影源。
2.  对于列表中的每一个电影，[`index.js`](./index.js) 调用 [`tmdb-api.js`](./tmdb-api.js) 模块。
3.  [`tmdb-api.js`](./tmdb-api.js) 负责与 TMDb API 交互，获取电影的详细信息，包括基本详情、Gimy 评级、演职员表等。
4.  [`index.js`](./index.js) 将从 Alist 和 TMDb 获取的数据进行合并与处理。
5.  所有处理完成的电影数据被完整地写入到 [`source/_data/movies.json`](../source/_data/movies.json) 文件中。
6.  电影列表页 (`/movies/`) 由 `hexo.extend.generator` 在生成阶段直接渲染 `movies.ejs` 模板生成。
7.  独立的播放页 (`/player/`) 在客户端通过 `fetch` 请求 `movies.json`。它会根据 URL 中的 `movie_id` 参数，在 JSON 数据中查找对应的电影信息并动态渲染到页面上。

## 4. 模块职责

*   **[`index.js`](./index.js)**: 插件的核心控制器。负责编排数据获取、处理和生成 `movies.json` 的整个流程。
*   **[`tmdb-api.js`](./tmdb-api.js)**: TMDb 数据获取模块。封装了所有与 TMDb API 相关的网络请求和数据提取逻辑。
*   **[`source/_data/movies.json`](../source/_data/movies.json)**: 最终的数据仓库。是前后端通信的桥梁，包含了所有电影的结构化数据。
*   **[`player/`](../source/player/)**: 独立的前端播放器应用。包含 `index.html`, `style.css`, `script.js`，负责展示和播放单个电影。

## 5. 未来开发指引

如果需要在播放页添加**新**的数据字段（例如“获奖信息”），请遵循以下步骤：

1.  **确认数据源**: 在 [`tmdb-api.js`](./tmdb-api.js) 中添加新的 API 请求或修改现有请求，确保能从 TMDb 获取到所需的新数据。
2.  **整合数据**: 在 [`index.js`](./index.js) 中调用 [`tmdb-api.js`](./tmdb-api.js) 的新方法，将获取到的新数据字段处理并合并到最终的对象中，确保它被正确写入 `movies.json`。
3.  **添加布局**: 修改 [`player/index.html`](../source/player/index.html)，为新数据添加相应的 HTML 元素占位。
4.  **设计样式**: 修改 [`player/style.css`](../source/player/style.css)，为新的布局元素添加样式。
5.  **渲染数据**: 修改 [`player/script.js`](../source/player/script.js)，在 `fetch` 成功后的回调函数中，将 `movies.json` 里的新数据显示到 `index.html` 的新布局中。
## 开发核心规则 (Core Development Rules)

*   在添加任何新的 API 相关功能时，**必须**首先搜索项目中的 API 缓存文档 (`FeHelper-20250809224120.json`)，以确认正确的 API 端点 (endpoint)、请求参数和返回的数据结构。此举是为了防止再次发生类似‘内容分级404’的错误，严禁在未经查证的情况下直接编写 API 调用代码。

## 疑难解答 (Troubleshooting)

### 1. 页面 404 问题

*   **问题描述**: 在 `hexo server` 模式下，访问 `/movies/` 页面时出现 404 错误，页面无法正常显示。
*   **根本原因**: `hexo server` 模式为了追求速度，采用了动态路由和内存缓存机制。这种机制与插件通过 `hexo.extend.generator.register` 注册的静态路由存在冲突，导致服务器无法正确识别和提供页面。
*   **解决方案**:
    *   **核心**: 放弃在 `server` 模式下依赖动态生成，回归标准的 Hexo 生成流程。
    *   **实施**:
        1.  使用 `hexo.extend.generator.register` 结合 `hexo.locals` 进行状态管理和页面生成。
        2.  在启动 `hexo server` 前，必须先执行 `hexo clean`，以清除旧的缓存和文件，确保生成器能够在一个干净的环境中运行。
        3.  执行 `hexo g` 生成静态文件，然后再执行 `hexo s` 启动服务。

### 2. 播放器 `blob:` URL 问题

*   **问题描述**: 在播放页中，尝试播放直链 MP4 文件时失败，浏览器开发者工具显示视频的 `src` 属性被改为了一个 `blob:` 开头的 URL。
*   **根本原因**: 这是由于不当使用 `Hls.js` 库导致的。`Hls.js` 是一个专门用于播放 HLS (HTTP Live Streaming) `.m3u8` 格式视频流的库，它会拦截视频请求并使用 `blob:` URL 进行分片加载。当它被错误地用于处理标准的 MP4 文件时，就会导致播放失败。
*   **解决方案**:
    *   **核心**: 精确控制 `Hls.js` 的使用范围，只在需要时初始化它。
    *   **实施**: 在 [`player/script.js`](../source/player/script.js) 中，添加一个简单的条件判断。只有当视频 URL 的结尾是 `.m3u8` 时，才创建并使用 `Hls.js` 实例。对于其他所有 URL (如 `.mp4`)，则直接将其赋值给 `<video>` 元素的 `src` 属性，使用浏览器原生的播放器进行播放。

### 3. 内容分级 404 问题

*   **问题**: 调用 TMDb API 获取内容分级时出现 404 错误。
*   **原因与解决方案**: 根本原因是混淆了 TMDb 的“电影 (Movie)”和“电视剧 (TV)”的 API。最初错误地使用了其他类型的 API 端点。**正确的解决方案是通过搜索本地保存的 API 文档（`FeHelper-*.json`），从中定位到了电影专用的正确端点：`/movie/{movie_id}/release_dates`**，并解析其返回数据中的 `certification` 字段，才成功获取到内容分级信息。